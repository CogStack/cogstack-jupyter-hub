services:
  cogstack-jupyter-hub-dev:
    build:
      context: ../
      dockerfile: "Dockerfile_hub"
    container_name: cogstack-jupyter-hub-dev
    restart: always
    environment:
      - http_proxy=$HTTP_PROXY
      - https_proxy=$HTTPS_PROXY
      - no_proxy=$NO_PROXY
      - JUPYTERHUB_INTERNAL_PORT=${JUPYTERHUB_INTERNAL_PORT:-8888}
      - JUPYTERHUB_INTERNAL_PROXY_API_PORT=${JUPYTERHUB_INTERNAL_PROXY_API_PORT:-8887}
      - JUPYTERHUB_SSL_PORT=${JUPYTERHUB_SSL_PORT:-443}
    env_file:
      - ../env/general.env
      - ../env/jupyter.env
    volumes:
      - jupyter-hub-shared-scratch:/home/jovyan/scratch
      - jupyter-hub-vol:/srv/jupyterhub
      # Security configs
      - ./${DEFAULT_SECURITY_DIR:-../security/}:/srv/jupyterhub/security:ro
      - ../config/jupyterhub_cookie_secret:/srv/jupyterhub/jupyterhub_cookie_secret:ro
      # User list and jupyter config
      - ../config/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro
      - ../config/userlist:/srv/jupyterhub/userlist:ro
      - ../config/teamlist:/srv/jupyterhub/teamlist:ro
      # Give access to Docker socket
      - /var/run/docker.sock:/var/run/docker.sock
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 262144
    ports:
      - "${JUPYTERHUB_INTERNAL_PORT:-8888}:${JUPYTERHUB_SSL_PORT:-443}"
    networks:
      - cognet

volumes:
  jupyter-hub-vol:
    driver: local
  jupyter-hub-shared-scratch:
    driver: local

networks:
  cognet:
    name: cogstack-net


